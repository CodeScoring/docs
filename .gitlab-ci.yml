stages:
  - lint

lint_markdown:
  stage: lint
  image: alpine:latest
  before_script:
    - apk add --no-cache curl grep
  script:
    - echo "üîç Starting markdown linting..."
    - |
      if [ -n "$CI_MERGE_REQUEST_DIFF_BASE_SHA" ]; then
        BASE_REF="$CI_MERGE_REQUEST_DIFF_BASE_SHA"
      else
        git fetch origin main
        BASE_REF="origin/main"
      fi

      FILES=$(git diff --name-only "$BASE_REF"...HEAD -- '*.md')

      if [ -z "$FILES" ]; then
        echo "‚ÑπÔ∏è No .md files changed. Skipping checks."
        exit 0
      fi

      echo "üìÑ Changed files:"
      echo "$FILES"

      ERROR_FOUND=false

      echo "üîç Checking for trailing spaces..."
      for file in $FILES; do
        if grep -n '[[:blank:]]$' "$file"; then
          echo "‚ùå Trailing spaces in $file"
          ERROR_FOUND=true
        fi
      done
      [ "$ERROR_FOUND" = false ] && echo "‚úÖ No trailing spaces."

      echo "üîç Checking for broken URLs..."
      for file in $FILES; do
        URLS=$(grep -oP '\[.*?\]\(\Khttp[s]?://[^\s)]+' "$file")
        if [ -n "$URLS" ]; then
          echo "üîó Checking URLs in $file..."
          echo "$URLS" | xargs -n1 -P4 sh -c 'curl --silent --head --fail "$0" --connect-timeout 3 --max-time 5 || { echo "‚ùå Broken URL: $0"; exit 1; }' 2>/dev/null || ERROR_FOUND=true
        else
          echo "‚ÑπÔ∏è No URLs in $file"
        fi
      done

      echo "üîç Checking internal links..."
      for file in $FILES; do
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Å—ã–ª–∫–∏ ([text](#anchor))
        LINKS=$(grep -oP '\[.*?\]\(\K#[^\s)]+' "$file" | sed 's/^#//')
        if [ -n "$LINKS" ]; then
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏—Ö –≤ —Ñ–æ—Ä–º–∞—Ç —è–∫–æ—Ä–µ–π
          ANCHORS=$(grep '^##\+' "$file" | sed 's/^##\+[[:space:]]*//' | tr '[:upper:]' '[:lower:]' | sed 's/[^–∞-—è–ê-–Øa-z0-9]/-/g; s/-\+/-/g; s/^-//; s/-$//')
          # –£—á–∏—Ç—ã–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ —è–∫–æ—Ä—è –≤–∏–¥–∞ _2 –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
          ANCHORS_WITH_NUM=$(grep '^##\+' "$file" | sed 's/^##\+[[:space:]]*//' | tr '[:upper:]' '[:lower:]' | sed 's/[^–∞-—è–ê-–Øa-z0-9]/-/g; s/-\+/-/g; s/^-//; s/-$//' | awk '{print $0; print "_" NR}')
          while IFS= read -r link; do
            if ! echo "$ANCHORS $ANCHORS_WITH_NUM" | grep -Fx "$link" >/dev/null; then
              echo "‚ùå Broken internal link '#$link' in $file"
              ERROR_FOUND=true
            fi
          done <<< "$LINKS"
        else
          echo "‚ÑπÔ∏è No internal links in $file"
        fi
      done

      if [ "$ERROR_FOUND" = true ]; then
        echo "‚ùå Linting failed."
        exit 1
      else
        echo "‚úÖ All checks passed!"
        exit 0
      fi