stages:
  - lint

fix_trailing_spaces:
  stage: lint
  image: alpine:latest
  script:
    - echo "üßπ Removing trailing spaces in changed .md files..."
    - |
      if [ -n "$CI_MERGE_REQUEST_DIFF_BASE_SHA" ]; then
        BASE_REF="$CI_MERGE_REQUEST_DIFF_BASE_SHA"
      else
        git fetch origin main
        BASE_REF="origin/main"
      fi

      FILES=$(git diff --name-only "$BASE_REF"...HEAD -- '*.md')

      if [ -z "$FILES" ]; then
        echo "‚ÑπÔ∏è  No .md files changed. Skipping."
        exit 0
      fi

      echo "üìÑ Fixing files:"
      echo "$FILES"

      for file in $FILES; do
        sed -i 's/[[:blank:]]\+$//' "$file"
      done

    - echo "üîç Checking if there are changes after cleanup..."
    - |
      if ! git diff --exit-code --quiet; then
        LAST_COMMITTER=$(git log -1 --pretty=format:'%an')
        if [ "$LAST_COMMITTER" = "CI Linter Bot" ]; then
          echo "üõë Already auto-fixed in last commit. Exiting to avoid loop."
          exit 0
        fi

        echo "‚úÖ Found and fixed trailing spaces. Committing changes..."
        git config user.name "CI Linter Bot"
        git config user.email "ci-linter@codescoring.local"

        git add $FILES
        git commit -m "chore(ci): auto-fix trailing spaces in markdown files [ci skip]"
        git push origin "HEAD:$CI_COMMIT_REF_NAME"
      else
        echo "‚úÖ No trailing spaces were found."
      fi
  only:
    - merge_requests
    - branches

