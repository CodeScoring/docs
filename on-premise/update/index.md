- [English](https://docs.codescoring.ru/on-premise/update.en/index.md)

# Обновление системы

## Стандартная инструкция по обновлению

Резервное копирование

Перед обновлением обязательно выполните резервное копирование платформы.

Для обновления необходимо иметь актуальные версии файлов `docker-compose.yml`, `external-db.override.yml`, `app.env` и `.env`, которые можно получить у вендора.

В переменной `CODESCORING_VERSION` внутри файла `.env` указывается требуемая версия системы. Актуальную версию можно узнать в разделе [Changelog](/changelog/on-premise-changelog).

Затем нужно выполнить следующие шаги:

1. Перейти в директорию с файлами запуска:

   ```
   cd /path/to/docker/compose
   ```

1. Выполнить команду обновления образов:

   ```
   docker compose pull
   ```

1. Перезапустить платформу:

   ```
   docker compose down --remove-orphans
   docker compose up -d --renew-anon-volumes
   ```

## Восстановление предыдущей версии

Если после обновления возникли ошибки или система работает нестабильно, можно восстановить предыдущую версию платформы из резервной копии:

1. Остановите текущую инсталляцию:

   ```
   docker compose down
   ```

1. Очистите базу данных любым удобным способом:

   - через Docker:

     ```
     docker volume rm <db_volume_name>
     ```

   - или удалив БД напрямую (например, `DROP DATABASE`);

   - или, при использовании Kubernetes:

     ```
     kubectl delete pvc <db_pvc_name>
     ```

1. Восстановите базу данных из ранее созданного бэкапа.

1. В файле `.env` установите прежнее значение переменной `CODESCORING_VERSION`.

1. Перезапустите платформу:

   ```
   docker compose up -d
   ```

Подробная инструкция по созданию резервных копий доступна в разделе [Резервное копирование](/on-premise/backup).

## Инструкции по обновлению на версии с измененной конфигурацией

### [2025.21.0] – 2025-05-21

Начиная с данной версии, значение переменной окружения `$SECRET_KEY` будет использоваться для шифрования чувствительных данных в базе данных и изменение значения этой переменной будет требовать дополнительных операций.

Перед обновлением необходимо убедиться, что в файле `.env` указано корректное (**уникальное, непредсказуемое**) значение `$SECRET_KEY`, а не значение по умолчанию.

### [2025.13.0] - 2025-03-28

- Необходимо убедиться, что версия `Docker Engine` больше или равна 25. Для этого нужно выполнить команду `docker version` на машине с платформой. В случае, если версия Docker Engine ниже, чем 25, необходимо обновить Docker.
  - **ВАЖНО!** Перед обновлением Docker необходимо штатно остановить платформу.
- Необходимо внести название проекта docker compose в конфигурацию:
  - Перед выключением системы для обновления, необходимо отметить название docker compose проекта, в котором сейчас запущена платформа.
  - Это либо значение, передаваемое с параметром `-p` для `docker compose`, либо название директории, в которой находился `docker-compose.yml` файл, по умолчанию -- `on-premise` или `on-premise-split-db`
  - Это значение используется как префикс в названии ресурсов, создаваемых compose: томов, контейнеров, сетей
  - Необходимо вписать это значение в `.env` файл c ключом `COMPOSE_PROJECT_NAME=`
  - **ВАЖНО!** Если этого не сделать, то платформа не запустится. Если вписать некорректное значение, то создадутся томы с новым префиксом, и платформа на новой версии запустится "с нуля"
  - После того, как значение добавлено в `.env` файл, вызовы к `docker compose` можно делать без опции `-p PROJECT_NAME`
- Необходимо скачать из реестра CodeScoring обновлённые файлы `docker-compose.yml` и `external-db.override.yml` и поместить их в директорию с compose файлом.
