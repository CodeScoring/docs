---
hide:
  - footer
---

# Разрешение зависимостей в окружении сборки

Пакетные менеджеры некоторых экосистем по умолчанию не включают транзитивные зависимости в манифесты. Для качественного проведения композиционного анализа при работе с ними рекомендуется применять механизм разрешения зависимостей в окружении сборки.

## Настройка разрешения зависимостей

Параметры разрешения зависимостей в окружении, пути к пакетному менеджеру и параметры выполнения регулируются следующими параметрами в команде `scan`:

- `--dotnet-resolve` / `--dotnet-path` / `--dotnet-args`
- `--go-resolve` / `--go-path`
- `--gradle-resolve` / `--gradle-path` / `--gradle-args`
- `--maven-resolve` / `--maven-path` / `--maven-args`
- `--npm-resolve` / `--npm-path` / `--npm-args`
- `--poetry-resolve` / `--poetry-path` / `--poetry-args`
- `--sbt-resolve` / `--sbt-path` / `--sbt-args`
- `--yarn-resolve` / `--yarn-path` / `--yarn-args`
- `--pip-resolve` / `--pip-path` / `--pip-args`
- `--composer-resolve` / `--composer-path` / `--composer-args`
- `--pnpm-resolve` / `--pnpm-path` / `--pnpm-args`
- `--conda-resolve` / `--conda-lock-path` / `--conda-args`

Пример команды:

``` bash
./johnny \
scan dir . \
--api_token <api_token> \
--api_url <api_url> \
--dotnet-resolve
--dotnet-path <path/to/dotnet>
```

При необходимости перечисленные параметры можно добавить в [конфигурационный файл агента](/agent/config).

При разрешении зависимостей в окружении агент проверяет отсутствие lock-файла, самостоятельно запускает пакетный менеджер или инструмент сборки и формирует полный список компонентов с учетом корректной версии сборки. На данный момент функциональность доступна для следующих экосистем:

### .NET

Для проектов .NET агент выполняет команду:

```bash
dotnet restore
````

После чего анализируется файл `obj/project.assets.json`, содержащий полную информацию о зависимостях и их версиях.

### Go

Агент использует данные из файлов `go.mod` и `go.sum`, добавляя записи из `go.sum`, которые отсутствуют в `go.mod` (только строки без постфикса `/go.mod`). Затем выполняется:

```bash
go mod graph
```

Полученный список пар `parent → child` используется для построения дерева зависимостей. При отсутствии указания родителя используется команда:

```bash
go mod why <package>
```

Если родительская связь не установлена, зависимость исключается с предупреждением.

### Gradle

Для разрешения зависимостей в Gradle по умолчанию необходимо задать следующее значение:

``` bash
--gradle-path : ./gradlew
```

С заданным значением сначала выполняется пользовательская задача:

```bash
./gradlew CodeScoring_All_Dependencies --configuration <конфигурация>
```

Если задача отсутствует, используется стандартная команда:

```bash
./gradlew dependencies --configuration <конфигурация>
```

Агент анализирует консольный вывод и формирует граф зависимостей.

### Maven

Для проектов Maven используется команда:

```bash
mvn dependency:tree -f <pom.xml> -DoutputFile=<tmpdir/mdt.json>
```

Агент парсит файл `mdt.json`, содержащий полную структуру зависимостей.

### npm

Агент выполняет:

```bash
npm install
```

Далее анализируется сформированный файл `package-lock.json`, фиксирующий дерево зависимостей и используемые версии.

### pnpm

Выполняется команда:

```bash
pnpm install
```

Анализируется lock-файл `pnpm-lock.yaml`, в котором содержатся данные обо всех зависимостях.

### yarn

Выполняется команда:

```bash
yarn install
```

Агент парсит файл `yarn.lock`, содержащий информацию о зависимостях и их версиях.

### pip

Для Python-проектов используется команда:

```bash
pip freeze
```

Результат команды фиксирует список установленных зависимостей и их версии.

### Poetry

Выполняются две команды:

```bash
poetry debug resolve --tree
poetry debug resolve
```

Первый вывод содержит дерево с констрейнтами, второй — конкретные версии. Агент сопоставляет данные и формирует итоговый граф.

### sbt (Scala)

Для Scala используется команда:

```bash
sbt dependencyTree
```

Анализируется консольный вывод, содержащий структуру зависимостей проекта.

### Swift

Для Swift-экосистемы агент выполняет:

```bash
swift build --package-path <путь_к_Package.swift>
```

Далее парсится файл `Package.resolved`, содержащий зафиксированные версии пакетов.

### Composer (PHP)

Выполняется команда:

```bash
composer install
```

Агент анализирует файл `composer.lock`, в котором зафиксировано состояние зависимостей.

### Conda

Для проектов, использующих Conda, агент выполняет:

```bash
conda-lock -f <environment.yml> --filename <tmpdir/conda-lock.yml>
```

После этого анализируется файл `conda-lock.yml`, в котором зафиксированы все зависимости проекта.
