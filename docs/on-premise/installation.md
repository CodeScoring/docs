# Установка системы

1. Установить Docker Engine под нужную операционную систему в соответствии с документацией: <https://docs.docker.com/engine/install/>.
2. Установить Docker Compose в соответствии с документацией: <https://docs.docker.com/compose/install/>.

    **Примечание**: для Mac и Windows шаг можно пропустить, т.к. утилита включена в установщик Docker Engine.

    **Примечание**: версия Docker Compose должна быть не ниже 1.29, но ниже версии 2.0. Установщик не будет работать корректно с Docker Compose версии 2.0 и выше.

3. Авторизоваться в приватном реестре Docker-образов системы «CodeScoring» при помощи команды `docker login`, используя адрес, логин и пароль, полученные от вендора.
4. Скачать архив с установочными файлами, распаковать.
5. Перейти в консоли в созданную директорию.
6. Скопировать шаблонный файл с настройками `app.env.template` в файл `app.env`. Как правило, для корректной работы никаких изменений в файле не требуется. При необходимости работы проекта через прокси, необходимо раскоментировать и задать значения для двух переменных: `HTTP_PROXY` и `HTTPS_PROXY`.

    **Важно**: при необходимости, ознакомьтесь с [настройками проекта для работы через прокси](/on-premise/proxy).

7. Скопировать шаблонный файл с секретами `.env.template` в `.env` и при необходимости изменить параметры конфигурации в новом файле.
Если не менять параметры в файле, то по умолчанию система будет запущена на адресе `http://localhost:8081`.

    **Примечание**: не используйте в параметрах символ `#`, он может некорректно восприниматься системой при установке. 

    - список доменов для правильной работы CSRF защиты, рекомендуется перечислить localhost на внутреннем и внешнем портах, а также внешний домен (или сочетание ip:порт), например:
        + `DJANGO_CSRF_TRUSTED_ORIGINS=localhost:18000,localhost:8081,внешний ip:8081`
    - параметры подключения к базе данных PostgreSQL. База поставляется вместе с установкой. Задание доступов отдельно является мерой предосторожности и контроля.
        + `POSTGRES_DB` — название базы данных
        + `POSTGRES_USER` — имя пользователя
        + `POSTGRES_PASSWORD` — пароль
    - секрет веб-приложения
        + `SECRET_KEY` — случайная строка символов
    - при согласии отправлять ошибки в систему сбора логов Sentry надо задать соответствующие переменные:
        + `SENTRY_ENABLED=True`
        + `SENTRY_DSN` — адрес отправки, значение будет предоставлено вендором отдельно
        + `SENTRY_ENVIRONMENT` — значение будет предоставлено вендором отдельно
        + `SENTRY_RELEASE=develop` — значение будет предоставлено вендором отдельно
    - настройки домена системы
        + `NGINX_HOST` — хост, по которому будет доступна система
        + `NGINX_PORT` — порт, по которому будет доступна система

8. Выполнить команду установки приложения CodeScoring (выполнение команды должно быть с правами суперпользователя системы):

    ```bash linenums="1"
    cd /path/to/docker-compose
    docker-compose -p PROJECT_NAME -f ./docker-compose.yml up -d --force-recreate --remove-orphans
    ```

    `PROJECT_NAME` — здесь и далее выбранное название проекта, по умолчанию использует название текущей директории

9. Для просмотра логов можно использовать команду:

    `docker-compose -p PROJECT_NAME logs -f`

10. После запуска сервис будет доступен по настроенному домену или адресу `http://localhost:8081`. При первом запуске дополнительно выполняются миграции базы данных, операция может занять больше времени, чем при последующих запусках.


11. Для входа в систему необходимо предварительно создать пользователя с правами администратора с помощью следующей команды (заменив `prefix_` значением `PROJECT_NAME` из пункта 8):

    ```bash linenums="1"
    docker exec -it prefix_backend_1 python ./manage.py createsuperuser
    ```

12. Для добавления ключа активации надо войти в систему, перейти в раздел Settings -> Activation key, ввести в форму ключ, нажать Save. В случае успеха на странице появится информация по ключу, поле Status должно быть в значении Active.

    **Примечание**: при копировании из файла важно не изменять содержимое ключа и не добавлять переносы строк.

    Ключ предоставляется вендором отдельно.