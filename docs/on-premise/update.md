---
hide:
  - footer
---
# Обновление системы

## Стандартная инструкция по обновлению

Для обновления необходимо иметь актуальные версии файлов `docker-compose.yml`, `app.env` и `.env`, которые можно получить у вендора.

В переменной `CODESCORING_VERSION` внутри файла `.env` указывается требуемая версия системы. Актуальную версию можно узнать в разделе [Changelog](/changelog/on-premise-changelog).

Затем нужно выполнить следующие шаги:

1. Перейти в директорию с файлами запуска:

    ```bash linenums="1"
    cd /path/to/docker-compose
    ```

2. Выполнить команду обновления образов:


    ```bash linenums="2"
    docker compose -p PROJECT_NAME pull
    ```

3. Перезапустить инсталляцию:

    ```bash linenums="3"
    docker compose -p PROJECT_NAME down --remove-orphans
    docker compose -p PROJECT_NAME up -d --renew-anon-volumes
    ```

## Инструкции по обновлению на версии с измененной конфигурацией

### [2025.13.0] - 2025-03-28

В данном релизе:

- Добавлены инструкции для проверок здоровья (healthcheck) сервисов
- Последовательность запуска сервисов реализована на основе механизма выше и критериев `service_healthy`, `service_completed_successfully`
- Пулер соединений `pgcat` заменён на `pgbouncer`
- Добавлены отдельные one-shot сервисы, выполняемые при старте инсталляции: `migrate` и `collectstatic`
- Произведён отказ от поддержки отдельной конфигурации со внешней СУБД (split-db), теперь вместо отдельного `docker-compose.yml` поставляется файл `external-db.override.yml`

Инструкция по обновлению для всех пользователей с инсталляцией в Docker Compose:

- Необходимо убедиться, что версия `Docker Engine` больше или равна 25. Для этого нужно выполнить команду `docker version` на машине с инсталляцией. В случае, если версия Docker Engine ниже, чем 25, необходимо обновить Docker.
    - **ВАЖНО!** Перед обновлением Docker необходимо штатно остановить инсталляцию.
- Необходимо внести название проекта docker compose в конфигурацию:
    - Перед выключением системы для обновления, необходимо отметить название docker compose проекта, в котором сейчас запущена инсталляция.
    - Это либо значение, передаваемое с параметром `-p` для `docker compose`, либо название директории, в которой находился `docker-compose.yml` файл, по умолчанию -- `on-premise` или `on-premise-split-db`
    - Это значение используется как префикс в названии ресурсов, создаваемых compose: томов, контейнеров, сетей
    - Необходимо вписать это значение в `.env` файл c ключом `COMPOSE_PROJECT_NAME=`
    - **ВАЖНО!** Если этого не сделать, то инсталляция не запустится. Если вписать некорректное значение, то создадутся томы с новым префиксом, и инсталляция на новой версии запустится "с нуля"
    - После того, как значение добавлено в `.env` файл, вызовы к `docker compose` можно делать без опции `-p PROJECT_NAME`
- Необходимо скачать из [реестра CodeScoring](https://registry-one.codescoring.ru) обновлённые файлы `docker-compose.yml` и `external-db.override.yml` и поместить их в директорию с compose файлом.
